<link rel="stylesheet" href="https://unpkg.com/primeflex@latest/primeflex.css">
<link rel="stylesheet" href="https://unpkg.com/primeicons@latest/primeicons.css">


<div class="grid grid-nogutter dashboard-container p-4">
    <!-- Left Column (Navigation, Search, etc.) -->
    <!-- Takes full width on small screens, 3/12 on large, 2/12 on extra-large -->
    <div class="col-12 lg:col-3 xl:col-2 pr-0 lg:pr-4 mb-4 lg:mb-0">

        <!-- Navigation Card -->
        <p-card header="Navigation" class="mb-4">
            <ul class="list-none p-0 m-0">
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-home mr-2"></i>
                    <a routerLink="/dashboard" class="text-900 text-sm">Dashboard</a>
                </li>
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-users mr-2"></i>
                    <a routerLink="/users" class="text-900 text-sm">Users</a>
                </li>
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-cog mr-2"></i>
                    <a routerLink="/settings" class="text-900 text-sm">Settings</a>
                </li>
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-chart-line mr-2"></i>
                    <a routerLink="/analytics" class="text-900 text-sm">Analytics</a>
                </li>
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-file mr-2"></i>
                    <a routerLink="/reports" class="text-900 text-sm">Reports</a>
                </li>
            </ul>
        </p-card>

        <!-- Search Card -->
        <p-card header="Search" class="mb-4">
            <div class="p-inputgroup mb-3">
                <span class="p-inputgroup-addon">
                    <!--i class="pi pi-search"></i-->
                </span>
                <input type="text" pInputText placeholder="Search..." class="w-full" />
            </div>
            <p-divider class="my-3"></p-divider>
            <!-- Use justify-content-between for potentially better spacing on wrap -->
            <div class="flex flex-wrap align-items-center justify-content-between gap-2">
                <button pButton pRipple label="Filter" icon="pi pi-filter" class="p-button-text p-button-secondary p-button-sm"></button>
                <button pButton pRipple label="Sort" icon="pi pi-sort" class="p-button-text p-button-secondary p-button-sm"></button>
                <button pButton pRipple label="Refresh" icon="pi pi-refresh" class="p-button-text p-button-secondary p-button-sm"></button>
            </div>
        </p-card>

        <!-- Notifications Card -->
        <p-card header="Notifications" class="mb-4">
            <ul class="list-none p-0 m-0">
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-bell mr-2"></i>
                    <a routerLink="/notifications" class="text-900 text-sm">Notifications</a>
                </li>
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-comment mr-2"></i>
                    <a routerLink="/messages" class="text-900 text-sm">Messages</a>
                </li>
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-calendar mr-2"></i>
                    <a routerLink="/events" class="text-900 text-sm">Events</a>
                </li>
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-ban mr-2"></i>
                    <a routerLink="/alerts" class="text-900 text-sm">Alerts</a>
                </li>
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-exclamation-triangle mr-2"></i>
                    <a routerLink="/warnings" class="text-900 text-sm">Warnings</a>
                </li>
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-info mr-2"></i>
                    <a routerLink="/info" class="text-900 text-sm">Info</a>
                </li>
            </ul>
        </p-card>

        <!-- Settings Card -->
        <p-card header="Settings" class="mb-4">
            <ul class="list-none p-0 m-0">
                <li class="flex align-items-center mb-2">
                    <i class="pi pi-cog mr-2"></i>
                    <a routerLink="/settings" class="text-900 text-sm">Settings</a>
                </li>
                <li class="flex align-items-center mb-2">
                     <i class="pi pi-lock mr-2"></i>
                     <a routerLink="/security" class="text-900 text-sm">Security</a>
                </li>
            </ul>
        </p-card>

    </div> <!-- End of Left Column -->


    <!-- Main Content Column (Backups & Chart) -->
    <!-- Takes full width on small screens, 6/12 on large, 7/12 on extra-large -->
    <div class="col-12 lg:col-6 xl:col-7 pr-0 lg:pr-4">

        <!-- Backups Section Header -->
        <div class="flex justify-content-between align-items-center mb-4 flex-wrap gap-2"> <!-- Added flex-wrap and gap -->
            <div>
                <h2 class="text-3xl font-bold text-900 mb-0">Backups <span class="text-xl text-600 ml-1">({{ buckets.length }})</span></h2>
                <p class="text-600 mt-1">Manage and initiate system backups using Ansible playbooks.</p>
            </div>
            <!-- Button Group -->
            <div class="flex gap-2"> <!-- Group buttons -->
                <button pButton pRipple label="Create a backup" (click)="showBackupDialog()" icon="pi pi-plus" class="p-button-primary"></button>
                <!-- Add User Button -->
                <button pButton pRipple label="Add User" (click)="showAddUserDialog()" icon="pi pi-user-plus" class="p-button-success"></button>
            </div>

            <!-- Backup Dialog -->
            <p-dialog header="Create New Backup Job" [(visible)]="backupDialogVisible" [modal]="true" [style]="{ width: '450px' }" [draggable]="false" [resizable]="false" (onHide)="hideBackupDialog()">
                <!-- ... dialog content ... -->
                 <div class="p-fluid flex flex-column gap-4 mt-3">
                    <div class="field">
                        <label for="backupName" class="font-semibold">Backup Name</label>
                        <input pInputText id="backupName" [(ngModel)]="backupName" required autofocus />
                        <small class="p-error" *ngIf="!backupName">Backup name is required.</small>
                    </div>
                    <div class="field">
                        <label for="targetHosts" class="font-semibold">Target Hosts/Group</label>
                        <input pInputText id="targetHosts" [(ngModel)]="targetHosts" required placeholder="e.g., webservers, 192.168.1.10" />
                         <small class="p-error" *ngIf="!targetHosts">Target hosts are required.</small>
                    </div>
                    <div class="field">
                        <label for="playbookPath" class="font-semibold">Ansible Playbook Path</label>
                        <input pInputText id="playbookPath" [(ngModel)]="playbookPath" required />
                         <small class="p-error" *ngIf="!playbookPath">Playbook path is required.</small>
                    </div>
                     <div class="field">
                        <label for="backupType" class="font-semibold">Backup Type</label>
                        <p-dropdown id="backupType" [options]="backupTypes" [(ngModel)]="selectedBackupType" optionLabel="label" optionValue="value" placeholder="Select a Type"></p-dropdown>
                    </div>
                    <div class="field">
                        <label for="extraVars" class="font-semibold">Extra Variables (Optional)</label>
                        <textarea pInputTextarea id="extraVars" [(ngModel)]="extraVars" rows="3" placeholder="key=value, key2=value2"></textarea>
                        <small>Comma-separated key-value pairs passed to Ansible.</small>
                    </div>
                </div>
                <ng-template pTemplate="footer">
                    <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideBackupDialog()"></button>
                    <button pButton pRipple label="Run Playbook" icon="pi pi-check" class="p-button-primary" (click)="runBackupPlaybook()" [disabled]="!backupName || !targetHosts || !playbookPath"></button>
                </ng-template>
            </p-dialog>
            <!-- End Backup Dialog -->

            <!-- Add User Dialog -->
            <p-dialog header="Add user" [(visible)]="addUserDialogVisible" [modal]="true" [style]="{ width: '600px' }" [draggable]="false" [resizable]="false" (onHide)="hideAddUserDialog()">
                <!-- Tabs for Single/Multiple (Simplified for now) -->
                <!-- <p-tabView> <p-tabPanel header="Single"> ... </p-tabPanel> </p-tabView> -->

                <div class="p-fluid flex flex-column gap-4 mt-3">
                    <!-- Account Name -->
                    <div class="field grid align-items-center">
                        <label for="accountName" class="col-12 mb-2 md:col-3 md:mb-0 font-semibold">Account Name:</label>
                        <div class="col-12 md:col-9">
                            <input pInputText id="accountName" [(ngModel)]="newUser.accountName" placeholder="Account Name (Optional)" />
                        </div>
                    </div>
                    <!-- Username -->
                    <div class="field grid align-items-center">
                        <label for="username" class="col-12 mb-2 md:col-3 md:mb-0 font-semibold">Username:</label>
                        <div class="col-12 md:col-9">
                            <input pInputText id="username" [(ngModel)]="newUser.username" placeholder="Username" required />
                            <!-- Add validation message if needed -->
                        </div>
                    </div>
                    <!-- Password -->
                    <div class="field grid align-items-center">
                        <label for="password" class="col-12 mb-2 md:col-3 md:mb-0 font-semibold">Password:</label>
                        <div class="col-12 md:col-9">
                            <div class="grid grid-nogutter">
                                <div class="col-fixed pr-2">
                                    <button pButton pRipple label="Random" icon="pi pi-key" class="p-button-outlined p-button-secondary"></button>
                                </div>
                                <div class="col">
                                    <p-password inputId="password" [(ngModel)]="newUser.password" [toggleMask]="true" placeholder="Password" styleClass="w-full" inputStyleClass="w-full" [feedback]="false"></p-password>
                                </div>
                                <div class="col pl-2">
                                    <p-password inputId="confirmPassword" [(ngModel)]="newUser.confirmPassword" [toggleMask]="true" placeholder="Confirm password" styleClass="w-full" inputStyleClass="w-full" [feedback]="false"></p-password>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Email -->
                    <div class="field grid align-items-center">
                        <label for="email" class="col-12 mb-2 md:col-3 md:mb-0 font-semibold">Email:</label>
                        <div class="col-12 md:col-9">
                            <input pInputText id="email" type="email" [(ngModel)]="newUser.email" placeholder="Email (Optional)" />
                        </div>
                    </div>
                    <!-- Apply Policy -->
                    <div class="field grid align-items-center">
                        <label for="policy" class="col-12 mb-2 md:col-3 md:mb-0 font-semibold">Apply Policy:</label>
                        <div class="col-12 md:col-9">
                            <p-dropdown id="policy" [options]="policyOptions" [(ngModel)]="newUser.selectedPolicy" placeholder="(none)" optionLabel="name" optionValue="code"></p-dropdown>
                        </div>
                    </div>

                    <!-- Storage Vault Provisioning -->
                    <div class="field">
                        <label class="font-semibold block mb-3">Storage Vault Provisioning</label>
                        <div class="grid align-items-center mb-3">
                            <label for="provisioningMode" class="col-12 mb-2 md:col-3 md:mb-0">Mode:</label>
                            <div class="col-12 md:col-9">
                                <p-dropdown id="provisioningMode" [options]="provisioningModeOptions" [(ngModel)]="newUser.selectedProvisioningMode" optionLabel="name" optionValue="code"></p-dropdown>
                                <small class="block mt-1 text-600">Additional vaults may also be provisioned at any time unless disallowed by policy.</small>
                            </div>
                        </div>
                        <div class="grid align-items-center">
                            <label for="provisioningTemplate" class="col-12 mb-2 md:col-3 md:mb-0">Template:</label>
                            <div class="col-12 md:col-9">
                                <p-dropdown id="provisioningTemplate" [options]="templateOptions" [(ngModel)]="newUser.selectedTemplate" placeholder="System Default [Currently: None]" optionLabel="name" optionValue="code"></p-dropdown>
                            </div>
                        </div>
                    </div>

                    <!-- Password Policy -->
                    <div class="field">
                        <label class="font-semibold block mb-3">Password Policy</label>
                        <div class="flex flex-column gap-2">
                            <div class="flex align-items-center">
                                <p-checkbox [(ngModel)]="newUser.allowAdminReset" [binary]="true" inputId="allowReset"></p-checkbox>
                                <label for="allowReset" class="ml-2">Allow administrator to reset password</label>
                            </div>
                            <div class="flex align-items-center">
                                <p-checkbox [(ngModel)]="newUser.requireChangeOnLogin" [binary]="true" inputId="requireChange"></p-checkbox>
                                <label for="requireChange" class="ml-2">Require user to change password at next login</label>
                            </div>
                        </div>
                    </div>

                </div>
                <ng-template pTemplate="footer">
                    <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideAddUserDialog()"></button>
                    <button pButton pRipple label="Add user" icon="pi pi-check" class="p-button-success" (click)="addUser()" [disabled]="!newUser.username || !newUser.password"></button> <!-- Basic validation -->
                </ng-template>
            </p-dialog>
            <!-- End Add User Dialog -->

        </div>

        <!-- Backups Accordion -->
        <p-accordion [multiple]="true" [activeIndex]="[0]">
            <p-accordionTab *ngFor="let bucket of buckets; let i = index" [selected]="i === 0">
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between w-full">
                        <div class="flex align-items-center">
                            <i [class]="bucket.icon + ' mr-2 text-xl'"></i>
                            <span class="font-semibold mr-2">{{ bucket.name }}</span>
                            <!-- Corrected severity value for warning -->
                            <p-tag [value]="bucket.status" [severity]="bucket.status === 'Completed' ? 'success' : (bucket.status === 'Running' ? 'info' : 'warn')"></p-tag>
                        </div>
                    </div>
                </ng-template>
                <div class="grid text-sm p-3">
                    <!-- Display backup details -->
                     <div class="col-6 md:col-4 mb-3">
                        <div class="text-500 font-medium mb-1">Created</div>
                        <div class="text-900">{{ bucket.created }}</div>
                    </div>
                     <div class="col-6 md:col-4 mb-3">
                        <div class="text-500 font-medium mb-1">Type</div>
                        <div class="text-900">{{ bucket.type }}</div>
                    </div>
                     <div class="col-6 md:col-4 mb-3">
                        <div class="text-500 font-medium mb-1">Size</div>
                        <div class="text-900">{{ bucket.size }}</div>
                    </div>
                     <div class="col-6 md:col-4 mb-3">
                        <div class="text-500 font-medium mb-1">ID</div>
                        <div class="text-900 font-mono text-xs">{{ bucket.id }}</div>
                    </div>
                     <div class="col-6 md:col-4 mb-3">
                        <div class="text-500 font-medium mb-1">Lifecycle</div>
                        <div class="text-900">{{ bucket.lifecycle }}</div>
                    </div>
                     <div class="col-6 md:col-4 mb-3">
                        <div class="text-500 font-medium mb-1">Encryption</div>
                        <div class="text-900">{{ bucket.encryption }}</div>
                    </div>
                </div>
                 <p-divider></p-divider>
                 <div class="flex justify-content-end gap-2 p-3 pt-0">
                     <button pButton pRipple label="Details" icon="pi pi-info-circle" class="p-button-text p-button-secondary"></button>
                     <button pButton pRipple label="Restore" icon="pi pi-undo" class="p-button-outlined p-button-secondary"></button>
                 </div>
            </p-accordionTab>
        </p-accordion>

        <!-- Chart Section -->
        <p-card header="Backup Overview" styleClass="mt-4">
             <p-chart type="line" [data]="chartData" [options]="chartOptions" height="300px"></p-chart>
        </p-card>

    </div> <!-- End of Main Content Column -->

    <!-- Right Column (Recent Activity) -->
    <!-- Takes full width on small screens, 3/12 on large, 3/12 on extra-large -->
    <div class="col-12 lg:col-3 xl:col-3 mt-4 lg:mt-0">
         <p-card>
            <ng-template pTemplate="title">
                <div class="flex justify-content-between align-items-center">
                    <span class="text-xl font-semibold text-900">Recent Activity</span>
                    <button pButton pRipple type="button" icon="pi pi-ellipsis-h" class="p-button-text p-button-secondary"></button>
                </div>
            </ng-template>
            <p-timeline [value]="recentActions" align="left" styleClass="recent-actions-timeline">
                 <ng-template pTemplate="marker" let-event>
                    <span class="custom-marker shadow-2 flex align-items-center justify-content-center" [style.backgroundColor]="event.color">
                        <i [class]="event.icon + ' text-sm'"></i>
                    </span>
                </ng-template>
                <ng-template pTemplate="content" let-event>
                    <div class="ml-2">
                        <div class="text-sm font-semibold text-900 mb-1">{{event.description}}</div>
                        <div class="text-xs text-500">{{event.date}} <span *ngIf="event.by">by {{event.by}}</span></div>
                    </div>
                </ng-template>
            </p-timeline>
        </p-card>
    </div> <!-- End of Right Column -->

</div> <!-- End of Main Grid -->

