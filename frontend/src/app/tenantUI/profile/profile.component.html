<link rel="stylesheet" href="https://unpkg.com/primeflex@latest/primeflex.css">
<link rel="stylesheet" href="https://unpkg.com/primeicons@latest/primeicons.css">

<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}" header="Confirm" icon="pi pi-exclamation-triangle"></p-confirmDialog>

<!-- Top Navigation Bar (Fixed) -->
<div id="topbar" class="flex align-items-center justify-content-end px-5 py-3 border-bottom-1 surface-border"
     style="background:#111317; position:fixed; top:0; left:0; right:0; height:64px; z-index:1001;">
  <div class="flex align-items-center gap-4">
    <p-splitButton 
      [label]="username" 
      icon="pi pi-user" 
      class="p-button-text p-button-rounded p-button-plain text-white"
      [model]="splitButtonItems"
      [style]="{ width: 'auto' }"
    ></p-splitButton>
  </div>
</div>

<!-- Sidebar (Fixed) -->
<aside id="sidebar" class="flex flex-column justify-content-between"
       style="position:fixed; top:64px; left:0; width:260px; height:calc(100vh - 64px); background:#111317; z-index:1000;">
  <div>
    <div class="flex align-items-center px-4 py-4 border-bottom-1 surface-border">
      <img src="/whitecapebcklogo.png" alt="Logo" height="65" />
    </div>
    
    <!-- Navigation -->
    <ul class="list-none p-0 m-0">
      <li>
        <a [routerLink]="['/', tenantName, 'dashboard']" class="flex align-items-center px-4 py-3 text-white hover:bg-blue-600 border-none border-round-sm my-1">
          <i class="pi pi-home mr-2"></i>
          <span>Dashboard</span>
        </a>
      </li>
    </ul>
    
    <ul class="list-none p-0 m-0">
      <li>
        <a [routerLink]="['/', tenantName, 'users']" class="flex align-items-center px-4 py-3 text-white hover:bg-blue-600 border-none border-round-sm my-1">
          <i class="pi pi-users mr-2"></i>
          <span>Users</span>
        </a>
      </li>
      <li>
        <a [routerLink]="['/', tenantName, 'backups']" class="flex align-items-center px-4 py-3 text-white hover:bg-blue-600 border-none border-round-sm my-1">
          <i class="pi pi-database mr-2"></i>
          <span>Backups</span>
        </a>
      </li>
      <li>
        <a [routerLink]="['/', tenantName, 'plans']" class="flex align-items-center px-4 py-3 text-white hover:bg-blue-600 border-none border-round-sm my-1">
          <i class="pi pi-calendar mr-2"></i>
          <span>Plans</span>
        </a>
      </li>
      <li>
        <a [routerLink]="['/', tenantName, 'repos']" class="flex align-items-center px-4 py-3 text-white hover:bg-blue-600 border-none border-round-sm my-1">
          <i class="pi pi-server mr-2"></i>
          <span>Repos</span>
        </a>
      </li>
      <li>
        <a [routerLink]="['/', tenantName, 'restore']" class="flex align-items-center px-4 py-3 text-white hover:bg-blue-600 border-none border-round-sm my-1">
          <i class="pi pi-replay mr-2"></i>
          <span>Restore</span>
        </a>
      </li>
    </ul>
    
    <ul class="list-none p-0 m-0 mb-4">
      <li>
        <a [routerLink]="['/', tenantName, 'job-logs']" class="flex align-items-center px-4 py-3 text-white hover:bg-blue-600 border-none border-round-sm my-1">
          <i class="pi pi-history mr-2"></i>
          <span>Job logs</span>
        </a>
      </li>
      <li>
        <a [routerLink]="['/', tenantName, 'analytics']" class="flex align-items-center px-4 py-3 text-white hover:bg-blue-600 border-none border-round-sm my-1">
          <i class="pi pi-chart-line mr-2"></i>
          <span>Analytics</span>
        </a>
      </li>
    </ul>
  </div>
</aside>

<!-- Main Content (Fixed, No Scroll) -->
<main style="
    position: fixed;
    top: 64px;
    left: 260px;
    width: calc(100vw - 260px);
    height: calc(100vh - 64px);
    background: #23272f;
    padding: 2rem;
    overflow: auto;
">
    <!-- Header -->
    <div class="flex align-items-center justify-content-between mb-4">
        <div class="flex align-items-center">
            <i class="pi pi-user mr-2 text-2xl"></i>
            <h2 class="text-2xl font-semibold mb-0 text-white">My Profile</h2>
        </div>
        <div class="flex gap-2">
            <button pButton pRipple label="Save Changes" icon="pi pi-save" class="p-button-success" 
                    [disabled]="!formChanged" (click)="saveProfile()"></button>
        </div>
    </div>

    <!-- Profile Tab View -->
    <div class="card p-0">
        <p-tabView>
            <!-- Personal Info Tab -->
            <p-tabPanel header="Personal Info">
                <div class="p-fluid grid formgrid">
                    <div class="field col-12 md:col-6">
                        <label for="firstName" class="block font-medium mb-2">First Name</label>
                        <input id="firstName" type="text" pInputText [(ngModel)]="user.first_name" (ngModelChange)="onFormChange()" />
                    </div>
                    
                    <div class="field col-12 md:col-6">
                        <label for="lastName" class="block font-medium mb-2">Last Name</label>
                        <input id="lastName" type="text" pInputText [(ngModel)]="user.last_name" (ngModelChange)="onFormChange()" />
                    </div>
                    
                    <div class="field col-12 md:col-6">
                        <label for="email" class="block font-medium mb-2">Email</label>
                        <input id="email" type="email" pInputText [(ngModel)]="user.email" (ngModelChange)="onFormChange()" />
                    </div>
                    
                    <div class="field col-12 md:col-6">
                        <label for="phone" class="block font-medium mb-2">Phone (optional)</label>
                        <input id="phone" type="tel" pInputText [(ngModel)]="user.phone" (ngModelChange)="onFormChange()" />
                    </div>
                    
                    <div class="field col-12">
                        <label for="company" class="block font-medium mb-2">Company (optional)</label>
                        <input id="company" type="text" pInputText [(ngModel)]="user.company" (ngModelChange)="onFormChange()" />
                    </div>
                </div>
                
                <p-divider></p-divider>
                
                <!-- Account Info -->
                <div class="p-fluid grid formgrid">
                    <div class="field col-12 md:col-6">
                        <label class="block font-medium mb-2">Username</label>
                        <input type="text" pInputText [value]="user.username" disabled class="bg-gray-200" />
                    </div>
                    
                    <div class="field col-12 md:col-6">
                        <label class="block font-medium mb-2">Role</label>
                        <input type="text" pInputText [value]="user.role_in_tenant | titlecase" disabled class="bg-gray-200" />
                    </div>
                    
                    <div class="field col-12 md:col-6">
                        <label class="block font-medium mb-2">Last Login</label>
                        <input type="text" pInputText [value]="formatDate(user.last_login)" disabled class="bg-gray-200" />
                    </div>
                    
                    <div class="field col-12 md:col-6">
                        <label class="block font-medium mb-2">Account Created</label>
                        <input type="text" pInputText [value]="formatDate(user.date_joined)" disabled class="bg-gray-200" />
                    </div>
                </div>
            </p-tabPanel>
            
            <!-- Password Tab -->
            <p-tabPanel header="Password">
                <div class="p-fluid">
                    <div class="field">
                        <label for="currentPassword" class="block font-medium mb-2">Current Password</label>
                        <p-password id="currentPassword" [(ngModel)]="passwordData.currentPassword" [toggleMask]="true" [feedback]="false" styleClass="w-full" (ngModelChange)="onPasswordFormChange()"></p-password>
                    </div>
                    
                    <div class="field">
                        <label for="newPassword" class="block font-medium mb-2">New Password</label>
                        <p-password id="newPassword" [(ngModel)]="passwordData.newPassword" [toggleMask]="true" [feedback]="true" styleClass="w-full" (ngModelChange)="onPasswordFormChange()"></p-password>
                    </div>
                    
                    <div class="field">
                        <label for="confirmPassword" class="block font-medium mb-2">Confirm New Password</label>
                        <p-password id="confirmPassword" [(ngModel)]="passwordData.confirmPassword" [toggleMask]="true" [feedback]="false" styleClass="w-full" (ngModelChange)="onPasswordFormChange()"></p-password>
                    </div>
                    
                    <div class="field-checkbox mt-3">
                        <p-checkbox [(ngModel)]="user.allow_admin_reset" [binary]="true" inputId="allowReset" (onChange)="onFormChange()"></p-checkbox>
                        <label for="allowReset" class="ml-2">Allow administrators to reset my password</label>
                    </div>
                    
                    <button pButton pRipple label="Change Password" icon="pi pi-key" class="p-button-primary mt-3" 
                            [disabled]="!passwordFormChanged || !passwordData.currentPassword || !passwordData.newPassword || !passwordData.confirmPassword"
                            (click)="changePassword()"></button>
                </div>
            </p-tabPanel>
            
            <!-- Preferences Tab -->
            <p-tabPanel header="Preferences">
                <div class="p-fluid">
                    <div class="field-checkbox mb-3">
                        <p-inputSwitch [(ngModel)]="uiPreferences.darkMode" inputId="darkMode"></p-inputSwitch>
                        <label for="darkMode" class="ml-2">Dark Mode</label>
                    </div>
                    
                    <div class="field-checkbox mb-3">
                        <p-inputSwitch [(ngModel)]="uiPreferences.compactView" inputId="compactView"></p-inputSwitch>
                        <label for="compactView" class="ml-2">Compact View</label>
                    </div>
                    
                    <p-divider></p-divider>
                    
                    <h3 class="mb-3 mt-4">Notifications</h3>
                    
                    <div class="field-checkbox mb-3">
                        <p-inputSwitch [(ngModel)]="uiPreferences.enableNotifications" inputId="enableNotifications"></p-inputSwitch>
                        <label for="enableNotifications" class="ml-2">Enable In-App Notifications</label>
                    </div>
                    
                    <div class="field-checkbox mb-3">
                        <p-inputSwitch [(ngModel)]="uiPreferences.emailAlerts" inputId="emailAlerts"></p-inputSwitch>
                        <label for="emailAlerts" class="ml-2">Send Email Alerts</label>
                    </div>
                    
                    <button pButton pRipple label="Save Preferences" icon="pi pi-save" class="p-button-primary mt-3" (click)="savePreferences()"></button>
                </div>
            </p-tabPanel>
            
            <!-- Account Tab -->
            <p-tabPanel header="Account">
                <div class="p-fluid">
                    <h3 class="mb-3">Account Status</h3>
                    <p class="mb-4">Your account is currently <span class="font-bold text-green-500">Active</span></p>
                    
                    <p-divider></p-divider>
                    
                    <div class="mt-4">
                        <h3 class="text-red-500 mb-3">Danger Zone</h3>
                        <p class="mb-4">Once you delete your account, there is no going back. Please be certain.</p>
                        <button pButton pRipple label="Request Account Deletion" icon="pi pi-trash" 
                                class="p-button-danger" (click)="requestAccountDeletion()"></button>
                    </div>
                </div>
            </p-tabPanel>
        </p-tabView>
    </div>
</main>
