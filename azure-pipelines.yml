trigger:
  branches:
    include:
      - main

resources:
  - repo: self

variables:
  # Update these values with your Azure Container Registry information
  dockerRegistryServiceConnection: 'your-acr-service-connection'
  containerRegistry: 'your-acr-name.azurecr.io'
  frontendImageRepository: 'wct-frontend'
  backendImageRepository: 'wct-backend'
  tag: '$(Build.BuildId)'
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: 'Build and Push Stage'
  jobs:
  - job: BuildFrontend
    displayName: 'Build Frontend'
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: 'Build and push frontend image'
      inputs:
        command: buildAndPush
        repository: $(frontendImageRepository)
        dockerfile: '$(Build.SourcesDirectory)/frontend/Dockerfile'
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest
  
  - job: BuildBackend
    displayName: 'Build Backend'
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: 'Build and push backend image'
      inputs:
        command: buildAndPush
        repository: $(backendImageRepository)
        dockerfile: '$(Build.SourcesDirectory)/backend/Dockerfile'
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest